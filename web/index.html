<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>课表</title>
    <!-- <script type="text/javascript" src="js/set_root.js"></script> -->
    <!-- <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script> -->
    <!-- jquery -->
    <script src="js/jquery.min.js"></script>
    <!-- bootstrap js -->
    <script src="js/bootstrap.min.js"></script>
    <!-- bootstrap css -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="css/reset.css"> -->
    <link rel="stylesheet" href="css/main.css">
    <!--validate验证表单插件-->
    <link rel="stylesheet" href="css/validation.css">
    <script src="js/jquery-1.11.1.js"></script>
    <script src="js/jquery.validate.min.js"></script>
    <script src="js/messages_zh.js"></script>
    <!-- <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/lib/jquery.js"></script>
    <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/jquery.validate.min.js"></script>
    <script src="http://static.runoob.com/assets/jquery-validation-1.14.0/dist/localization/messages_zh.js"></script> -->
    <!-- datetimepicker时间插件 -->
    <script src="js/bootstrap-datetimepicker.min.js"></script>
    <script src="js/bootstrap-datetimepicker.zh-CN.js"></script>
    <link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css">
    <script>
        // 添加validation验证方法
        $.validator.addMethod("isDatetime",function(value,element){
            var score =  /^[0-9]{4}-[0-1]?[0-9]{1}-[0-3]?[0-9]{1} (0\d{1}|1\d{1}|2[0-3]):([0-5]\d{1})$/;
            return this.optional(element) || (score.test(value));
        },"<font>请输入正确的时间格式 (2018-01-01 08:00)</font>");

        //定义一个变量用于存储添加和修改时不同的URL
        var myUrl = 'lesson/update';

        //表单字段验证
        //如果按照一般验证的写法，只能调用整个表单的validate函数，而不能调用自定义的user_name验证，所以把两个函数封装成为一个，在点击按钮时调用
        function vali() {
            //form-data表单验证。
            $("#form-data").validate({
                onfocusout:function(element) { $(element).valid(); },
                onblur: function(element) { $(element).valid(); },    //鼠标移开验证。这里写onblue:true没有效果
                onsubmit:true,      //提交时验证（有效）
                onkeyup:false,
                rules:{
                    teacher:{
                        required:true,
                    },
                    lesson:{
                        required:true,
                    },
                    start:{
                        required:true,
                        isDatetime:true,
                    },
                    end:{
                        required:true,
                        isDatetime:true,
                    }
                },
                messages:{
                    teacher:{
                        required:"请选择老师",
                    },
                    lesson:{
                        required:"请选择课程",
                    },
                    start:{
                        required:"请选择开始时间",
                    },
                    end:{
                        required:"请选择结束时间",
                    }
                },
                submitHandler:function (form) {
                    checkForm();
                }
            });
        }
    
        /*
        点击添加用户时需要做的操作：
            1.修改提交表单的URL
            2.将user_name的readonly属性移除
            3.清空表单数据
            */
        function setUrl() {
            // myUrl='/student/add';
            // myUrl='lesson/update';
            // $('#user_id').removeAttr("readonly");
            // $('#form-data input').val("");
            initModal();
        }
    
    
        function checkForm() {
            var formData = new FormData();
            formData.append('teacher', $('#teacher').val());
            formData.append('lesson', $('#lesson').val());
            formData.append('start', $('#start').val());
            formData.append('end', $('#end').val());
            if($('#user_id').val()!='') {
                formData.append('user_id', $('#user_id').val());
            }
            // console.log(formData.get('user_id'));

            $.ajax({
                    url:myUrl,      //根据操作传入不同的URL
                    data:formData,  //传入序列化的表单对象
                    type:"post",
                    dataType:'json',
                    async:false,    //异步传输
                    timeout:50000,
                    //设置编码
                    // contentType: "application/x-www-form-urlencoded; charset=utf-8",
                    // contentType: "'application/json",
                    // headers:{"X-CSRFToken":$.cookie('csrftoken')},
                    processData: false,  // 不处理数据
                    contentType: false,
                    beforeSend:function () {
                        $('#tip').html('<span style="color: cornflowerblue">正在处理...</span>');
                        return true;
                    },
                    success:function (data) {
                        console.log(data);
                        if(data){
                            $('#tip').html('<span style="color: green">操作成功！</span>');
                            location.reload(true);
                        }else{
                            $('#tip').html('<span style="color: red">操作失败，请重试</span>');
                        }
                    },
                    error:function(XMLHttpRequest, textStatus, errorThrown) {
                        // alert(XMLHttpRequest.status);//状态码
                        // alert(XMLHttpRequest.readyState);//状态
                        // alert(textStatus);//错误信息
                        alert("出错了");
    
                    },
                    complete:function () {
    
                    }
            });
        }

        // 初始化模态框
        function initModal() {
            $('#tip').empty();
            $('#user_id').empty();
            $('#start').empty();
            $('end').empty();

            $.post('teacher/info/', function(dic) {
                var teacher = $('#teacher');
                teacher.empty().append('<option value="">请选择老师</option>');
                $.each(dic.data, function(index, item) {
                    teacher.append('<option values='+item.id+'>'+item.name+'</option>');
                });
            });
            $.post('lesson/info/', function(dic) {
                var lesson = $('#lesson');
                lesson.empty().append('<option value="">请选择课程</option>');
                $.each(dic.data, function(index, item) {
                    lesson.append('<option values='+item.id+'>'+item.name+'</option>');
                });
            });
        };

        $(function(){
            // 课程点击事件
            $('.lesson').click(function(){
                // var re = /^(\S+?) (\S+?)$/;

                var _id = $(this).attr('id');
                // var lesson_info = $(this).find('.lesson_info').text();
                // var start_time = $(this).find('.start_time').text();
                // var end_time = $(this).find('.end_time').text();
                // var teacher = lesson_info.match(re)[1];
                // var lesson = lesson_info.match(re)[2];
                // 初始化模态框
                initModal();
                // 查询信息
                $.ajax({
                    url: myUrl,
                    data: {'id': _id},
                    type: 'post',
                    scriptCharset: 'utf-8',
                    beforeSend: function () {
                        return true;
                    },
                    success: function (data) {
                        if(data){
                            // 解析json
                            var data = data;
                            var lesson_info = eval("("+data+")");
                            // 赋值
                            $('#user_id').val(lesson_info.lesson_id);
                            $('#start').val(lesson_info.start);
                            $('#end').val(lesson_info.end);
                            $('#teacher').find('option:contains('+lesson_info.teacher+')').attr('selected', true);
                            $('#lesson').find('option:contains('+lesson_info.lesson+')').attr('selected', true);
                        }
                    }
                });
                // 赋值
                // $('#user_id').val(_id);
                // $('#start').val(start_time);
                // $('#end').val(end_time);
                // $('#teacher option[text='+teacher+']').attr('selected','selected');
                // $('#lesson option[text='+lesson+']').attr('selected','selected');
            });
        });
    
    </script>
    <!-- 时间选择器 -->
    <script>
        $(function(){
            $("#start").datetimepicker({
                format:'yyyy-mm-dd hh:ii',  //格式  如果只有yyyy-mm-dd那就是0000-00-00
                autoclose:true,//选择后是否自动关闭 
                minView:0,//最精准的时间选择为日期  0-分 1-时 2-日 3-月
                language:  'zh-CN', //中文
                weekStart: 1, //一周从星期几开始
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                forceParse: 0,
            // daysOfWeekDisabled:"1,2,3", //一周的周几不能选 格式为"1,2,3"  数组格式也行
                todayBtn : true,  //在底部是否显示今天
                todayHighlight :false, //今天是否高亮显示
                keyboardNavigation:true, //方向图标改变日期  必须要有img文件夹 里面存放图标
                showMeridian:false,  //是否出现 上下午
                initialDate:new Date()
                //startDate: "2017-01-01" //日期开始时间 也可以是new Date()只能选择以后的时间
            }).on("changeDate",function(){
                var start = $("#start").val();
                $("#end").datetimepicker("setStartDate",start);
            }); 
            $("#end").datetimepicker({
                format:'yyyy-mm-dd hh:ii',  //格式  如果只有yyyy-mm-dd那就是0000-00-00
                autoclose:true,//选择后是否自动关闭 
                minView:0,//最精准的时间选择为日期  0-分 1-时 2-日 3-月
                language:  'zh-CN', //中文
                weekStart: 1, //一周从星期几开始
                todayBtn:  1,
                autoclose: 1,
                todayHighlight: 1,
                startView: 2,
                forceParse: 0,
                //daysOfWeekDisabled:"1,2,3", //一周的周几不能选
                todayBtn : true,  //在底部是否显示今天
                todayHighlight :false, //今天是否高亮显示
                keyboardNavigation:true, //方向图标改变日期  必须要有img文件夹 里面存放图标
                showMeridian:false  //是否出现 上下午
            // startDate: "2017-01-01"  //开始时间  ENdDate 结束时间
            }).on("changeDate",function(){
                var end = $("#end").val();
                $("#start").datetimepicker("setEndDate",end);
            });   
        });
    </script>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">切换导航</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">课程管理系统</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">课表</a></li>
                    <li><a href="#about">学生课程管理</a></li>
                    <li><a href="#contact">老师课程管理</a></li>
                    <!-- <li><a href="#contact">课程种类</a></li> -->
                    <!-- <li><a href="#contact">学生课程管理</a></li> -->
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                            其他 <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#">学生管理</a></li>
                            <li><a href="#">老师管理</a></li>
                            <li><a href="#">课程种类</a></li>
                            <!-- <li role="separator" class="divider"></li>
                            <li class="dropdown-header">Nav header</li>
                            <li><a href="#">Separated link</a></li>
                            <li><a href="#">One more separated link</a></li> -->
                        </ul>
                    </li>
                </ul>
                <!-- <ul class="nav navbar-nav navbar-right">
                    <li><a href="../navbar/">Default</a></li>
                    <li class="active"><a href="./">Static top <span class="sr-only">(current)</span></a></li>
                    <li><a href="../navbar-fixed-top/">Fixed top</a></li>
                </ul> -->
            </div><!--/.nav-collapse -->
        </div>
    </nav>
    <div class="jumbotron">
        <div class="container">
            <p class="text-right"><button type="button" class="btn btn-warning" data-toggle="modal" data-target="#updateModal" onclick="setUrl()">添加课程</button></p>
            <!--模态框-->
            <form method="post" name="user" class="form-horizontal" role="form" id="form-data"  style="margin: 20px;" >
                <div class="modal fade" id="updateModal"   tabindex="-1" role="dialog" aria-labelledby="updateModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                    ×
                                </button>
                                <h4 class="modal-title" id="updateModalLabel">
                                    课程信息
                                </h4>
                            </div>
                            <div class="modal-body">
                                <form action="" class="form-horizontal">
                                    <!--user_id为隐藏的input，便于update时的传值-->
                                    <input type="text" id="user_id" name="user_id" hidden>
                                    <!-- <div class="form-group">
                                        <label for="teacher" class="col-sm-3 control-label mark_location">
                                            老师
                                            <span class="star">*</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <select class="form-control" id="teacher" name="teacher">
                                                <option value="">请选择老师</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="form-group">
                                        <label for="lesson" class="col-sm-3 control-label mark_location">
                                            课程
                                            <span class="star">*</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <select class="form-control" id="lesson" name="lesson">
                                                <option value="">请选择课程</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="start" class="col-sm-3 control-label mark_location">
                                            开始时间
                                            <span class="star">*</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" placeholder="开始时间" id="start" name="start" autocomplete='off'>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="end" class="col-sm-3 control-label mark_location">
                                            结束时间
                                            <span class="star">*</span>
                                        </label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" placeholder="结束时间" id="end" name="end" autocomplete='off'>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                                <!--type为submit时，会自动调用该表单的验证，但是不会调用自己定义的动态的user_name的验证，
                                所以把按钮类型改为input，再手动调用封装好的验证函数-->
                                <button type="input" class="btn btn-primary" onclick="vali();">提交</button>
                                <span id="tip"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <td>时间</td>
                            <td>8月1日 星期一</td>
                            <td>8月2日 星期二</td>
                            <td>8月3日 星期三</td>
                            <td>8月4日 星期四</td>
                            <td>8月5日 星期五</td>
                            <td>8月6日 星期六</td>
                            <td>8月7日 星期日</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">上午</th>
                            <td class="text-muted">
                                <div class="lesson" id="143" data-toggle="modal" data-target="#updateModal">
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                    <div class="start_time">2018-01-01 08:00</div>
                                    <div class="end_time">2018-01-01 09:00</div>
                                </div>
                                <div class="lesson" id="143" data-toggle="modal" data-target="#updateModal">
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                    <div class="start_time">2018-01-02 09:00</div>
                                    <div class="end_time">2018-01-02 10:00</div>
                                </div>
                                <div class="lesson" onclick="update(123)">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">下午</th>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">晚上</th>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <td>时间</td>
                            <td>8月1日 星期一</td>
                            <td>8月2日 星期二</td>
                            <td>8月3日 星期三</td>
                            <td>8月4日 星期四</td>
                            <td>8月5日 星期五</td>
                            <td>8月6日 星期六</td>
                            <td>8月7日 星期日</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">上午</th>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                                <div class="lesson">
                                    <div class="lesson_time">8月1日 08:00 1.5H</div>
                                    <div class="lesson_info">李老师 李某某(语文)</div>
                                </div>
                            </td>
                            <td class="text-muted">
                                
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">下午</th>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                        </tr>
                        <tr>
                            <th scope="row">晚上</th>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                            <td class="text-muted">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>
    <!-- <div class="jumbotron">

        <h1>Jumbotron heading</h1>
        <p class="lead">
            Cras justo odio, dapibus ac facilisis in, egestas eget quam. Fusce dapibus, tellus ac cursus commodo, tortor mauris condimentum nibh, ut fermentum massa justo sit amet risus.
        </p>
        <p>
            <a class="btn btn-lg btn-success" href="#" role="button">Sign up today</a>
        </p>
    </div> -->
</body>
</html>